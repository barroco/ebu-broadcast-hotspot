package org.ebu.medialab.player;

import org.ebulabs.hotspot.HotspotException;
import org.xbill.DNS.CNAMERecord;
import org.xbill.DNS.Lookup;
import org.xbill.DNS.Record;
import org.xbill.DNS.SRVRecord;
import org.xbill.DNS.Type;

import android.util.Log;

public class RadioDNS {
	
	static final String LOG_SRC = "RadioDNS";
	
	String server;
	int port;
	
	public String getServer() { return server; }
	public int getPort() { return port; }
	
	public RadioDNS(String request) throws HotspotException {
		Record[] records;
		Lookup l1 = null;
		Lookup l2 = null;
		try {
			String initialreq = request + ".radiodns.org";
			l1 = new Lookup(initialreq, Type.CNAME);
			Record[] r1 = l1.run();
			Log.d(LOG_SRC, "DNS CNAME LOOKUP:" + initialreq + " (status:" + l1.getResult() + ")");

			String cname = "";
			if (r1.length > 0) {
				CNAMERecord r  = (CNAMERecord) r1[0];
				cname = r.getAlias().toString();
				cname = cname.substring(0, cname.length()-1);
				Log.d(LOG_SRC, "RESULT CNAME:" + r.getAlias());
			}

			String servicereq = "_radiovis._tcp." + cname;
			l2 = new Lookup(servicereq, Type.SRV);
			records = l2.run();
			Log.d(LOG_SRC, "DNS SRV LOOKUP:" + servicereq+" (status:" + l2.getResult() + ")");


			if (records.length > 0) {
				SRVRecord srv = (SRVRecord) records[0];
				String server = srv.getTarget().toString();
				server.substring(0, server.length()-1);		        	

				Log.d(LOG_SRC, "RESULT SRV: " + server + ":" + srv.getPort());

				this.server = server;
				this.port = srv.getPort();
			} 

		} 
		catch (Exception e) {
			Log.e(LOG_SRC, "error");
			e.printStackTrace();
			throw new HotspotException(e);
		}
	}

}

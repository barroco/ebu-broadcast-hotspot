package org.ebulabs.radiodns;

import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintStream;
import java.net.Socket;
import java.nio.CharBuffer;
import java.util.HashMap;

import android.util.Log;

import com.sun.xml.internal.stream.buffer.stax.StreamReaderBufferCreator;

public class RadioVisDAB {
	
	RadioDNS visserver;
	StompConnectionHandler stomp;
	String topic;
	
	/**
	 * Create a new RadioVisDAB instance.
	 * 
	 * All parameters are hexadecimal strings (without "0x" prefix)
	 * 
	 * @param ECC Extended Country Code
	 * @param EId Ensemble Id
	 * @param SId Service Id
	 * @param SubCHId Subchannel Id
	 * @throws RadioDNSException 
	 */
	public RadioVisDAB(String ECC, String EId, String SId, String SubCHId, RadioVisCallbacks callbacks) throws RadioDNSException {
		this.visserver = new RadioDNS(SubCHId + "." + SId + "." + EId + "." + ECC + ".dab");
		
		this.topic = "/topic/dab/" + ECC + "/" + EId + "/" + SId + "/" + SubCHId;
		
		this.stomp = new StompConnectionHandler(visserver.getServer(), visserver.getPort(), callbacks, this.topic);
	}
	
	public void start() {
		this.stomp.start();
	}
}

class StompConnectionHandler extends Thread {
	Socket sock;
	RadioVisCallbacks callbacks;
	String topic;
	String server;
	int port;
	
	boolean run;
	
	Exception lastError;
	
	public StompConnectionHandler(String server, int port, RadioVisCallbacks callbacks, String topic) throws RadioDNSException {
		this.callbacks = callbacks;
		this.topic = topic;
		this.server = server;
		this.port = port;
		this.run = true;
		
	}
	
	@Override
	public void run() {
		
		try {
			sock = new Socket(server, port);
			PrintStream out = new PrintStream(sock.getOutputStream());
			InputStreamReader in = new InputStreamReader(sock.getInputStream());
			
			out.print("CONNECT\n\n\0");
			String r = receiveMessage(in);
			String rs[] = r.split("\n");
			
			if (rs.length == 0 || !rs[0].equals("CONNECTED")) {
				Log.e("RadioDNS", "Could not connect");
				throw new RadioDNSException("Did not receive correct answer from server");
			}
			
			Log.e("RadioDNS", "Subscribing to " + topic);
			out.print("SUBSCRIBE\ndestination: " + this.topic + "\nack: auto\n\n\0");
			
			while (this.run) {
				r = receiveMessage(in);
				
				StompMessage msg = StompMessage.parse(r);
				
				Log.d("RadioDNS", "Got message " + msg.toString());
			}
			
			sock.close();
			
		} 
		catch (Exception e) {
			e.printStackTrace();
			
			this.lastError = new RadioDNSException(e);
		}
	}
	
	public void stopReceiver() {
		synchronized (this) {
			try {
				sock.close();
			} catch (IOException e) {
				e.printStackTrace();
			}
			this.run = false;
		}
		
	}
	
	String receiveMessage(InputStreamReader in) throws RadioDNSException {
		StringBuilder sb = new StringBuilder();
		
		char[] c = new char[1];
		
		try {
			while (in.read(c) != -1) {
				if (c[0] == '\0')
					break;
				sb.append(c[0]);
			}
		}
		catch (IOException e) {
			e.printStackTrace();
			Log.e("RadioDNS", "receiveToken failed");
			throw new RadioDNSException(e);
		}
		
		return sb.toString();
	}
}

class StompMessage {
	
	String message;
	
	public String command;
	public HashMap<String, String> headers;
	public String body;
	
	public String toString() {
		return this.message;
	}
	
	public static StompMessage parse(String in) {
		StompMessage msg = new StompMessage();
		
		Log.d("RadioDNS", "parse " + in);
		
		// Advance to first \n
		int i = 0;
		
		i = in.indexOf('\n');
		msg.command = in.substring(0, i);
		
		i++; // Eat the \n
		
		int j = in.indexOf("\n\n");
		
		// headers go from i to j
		
		String headers = in.substring(i, j);
		
		msg.headers = new HashMap<String, String>();
		
		for (String kv : headers.split("\n")) {
			String key_val[] = kv.split(":", 1);
			if (key_val.length == 2)
				msg.headers.put(key_val[0], key_val[1]);
		}
		
		msg.body = in.substring(j+2, -1);
		
		return msg;
	}
}
